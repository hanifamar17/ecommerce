{% extends "base.html" %}

{% block title %}{{title}}{% endblock %}

{% block content %}
{% load widget_tweaks %}


<div class="w-full text-gray-800 p-8 bg-gray-50 rounded-md">
    <!-- Header -->
    <div class="flex items-center justify-between border-b border-gray-200 mb-4">
        <div class="text-center md:text-left space-y-2 mb-4">
            <h1 class="text-xl font-semibold text-gray-800">{% if form.instance.pk %}Edit Produk{% else %}Tambah
                Produk{% endif %}</h1>
            <p class="text-gray-600 text-sm">{% if form.instance.pk %}Edit{% else %}Tambah{% endif %} informasi produk
                untuk dimasukkan ke katalog produk
            </p>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav class="mb-6">
        <a href="{% url 'product_list' %}" class="text-gray-500 hover:text-gray-700 text-sm flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Kembali ke Daftar Produk
        </a>
    </nav>

    <div class="flex md:flex-row mt-8 gap-10">
        <div class="md:w-1/2">
            <h1 class="text-gray-800">Informasi Kategori</h1>
            <p class="text-gray-600 text-sm">Pastikan informasi kategori yang dimasukkan benar</p>


            {% if form.instance.pk and form.instance.image %}
            <div class="mt-6">
                <h1 class="text-gray-800 mb-2">Produk Utama Saat Ini</h1>
                <div class="relative hover:shadow-sm transition-shadow duration-200">
                    <img src="{{ form.instance.image.url }}" class="w-full object-cover rounded-lg">
                </div>
            </div>
            {% endif %}

            {% if form.instance.pk and form.instance.gallery.all %}
            <div class="mt-6">
                <h1 class="text-gray-800 mb-2">Galeri Produk Saat Ini</h1>
                <div class="grid grid-cols-3 gap-4">
                    {% for img in form.instance.gallery.all %}
                    <div class="relative hover:shadow-sm transition-shadow duration-200">
                        <img src="{{ img.image.url }}" class="w-full h-32 object-cover rounded-lg">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="md:w-1/2">
            <!-- Form Container -->
            <form id="productForm" method="post" enctype="multipart/form-data"
                action="{% if form.instance.pk %}{% url 'edit_product' form.instance.pk %}{% else %}{% url 'add_product' %}{% endif %}"
                class="space-y-5">
                {% csrf_token %}

                <!-- Kategori -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Kategori
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.category.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Nama Produk -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Nama Produk
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Deskripsi -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Deskripsi
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Harga dan Stok -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Harga
                        </label>
                        <div class="relative">
                            <span
                                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">Rp</span>
                            {{ form.price }}
                        </div>
                        {% if form.price.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.price.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Stok
                        </label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.stock.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Upload gambar utama-->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Gambar Utama Produk
                    </label>
                    <div id="mainImageUpload"
                        class="w-full px-4 py-8 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors duration-200 text-center bg-gray-50 hover:bg-blue-50 cursor-pointer">
                        <input type="file" name="image" id="mainImageInput" accept="image/*" class="hidden">
                        <div class="space-y-2 pointer-events-none">
                            <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            <div id="mainImageText" class="text-sm text-gray-600">
                                <span class="font-medium text-blue-600">Klik untuk upload</span>
                                <p class="text-xs text-gray-500 mt-1">Pilih 1 gambar saja</p>
                            </div>
                        </div>
                    </div>
                    {% if form.image.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.image.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Upload galleri-->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Gambar Galeri Produk
                    </label>
                    <div id="galleryUpload"
                        class="w-full px-4 py-6 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors duration-200 text-center bg-gray-50 hover:bg-blue-50 cursor-pointer">
                        <div class="space-y-2 pointer-events-none">
                            <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            <input type="file" name="gallery_images" id="galleryInput" multiple accept="image/*"
                                class="hidden">
                            <p id="galleryText" class="text-sm font-medium text-blue-600">Klik untuk upload galeri</p>
                            <p class="text-xs text-gray-500 mt-1">Bisa pilih lebih dari 1 gambar</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 pt-4">
                    <a href="{% url 'product_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md 
      text-gray hover:bg-gray-100 focus:outline-none 
      focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 no-print cursor-pointer">
                        Batal
                    </a>
                    <button id="submitBtn" type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md 
      text-white bg-blue-600 hover:bg-blue-700 focus:outline-none 
      focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 no-print cursor-pointer">
                        <span id="btnText">
                            {% if form.instance.pk %}Perbarui Produk{% else %}Simpan Produk{% endif %}
                        </span>
                        <svg id="btnSpinner" class="hidden ml-2 w-4 h-4 text-white animate-spin"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                    </button>
                </div>
            </form>

            <!-- Footer Info -->
            <div class="text-center mt-6">
                <p class="text-xs text-gray-500">
                    Pastikan semua informasi sudah benar sebelum menyimpan
                </p>
            </div>
        </div>
    </div>

    <!-- Container Toast -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2 overflow-hidden"></div>

</div>

<!-- File Upload Interaction -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Main image
        const mainUpload = document.getElementById('mainImageUpload');
        const mainInput = document.getElementById('mainImageInput');
        const mainText = document.getElementById('mainImageText');

        mainUpload.addEventListener('click', () => mainInput.click());
        mainInput.addEventListener('change', function () {
            const fileName = this.files[0]?.name;
            if (fileName) {
                mainText.innerHTML = `
                <span class="font-medium text-green-600">File terpilih: ${fileName}</span>
                <p class="text-xs text-gray-500 mt-1">Klik untuk mengganti</p>
            `;
            }
        });

        // Gallery
        const galleryUpload = document.getElementById('galleryUpload');
        const galleryInput = document.getElementById('galleryInput');
        const galleryText = document.getElementById('galleryText');

        galleryUpload.addEventListener('click', () => galleryInput.click());
        galleryInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                galleryText.innerHTML = `
                <span class="font-medium text-green-600">${this.files.length} file dipilih</span>
                <p class="text-xs text-gray-500 mt-1">Klik untuk mengganti</p>
            `;
            }
        });
    });
</script>

<!-- Button Loading State -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("productForm");
        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");
        const btnSpinner = document.getElementById("btnSpinner");

        form.addEventListener("submit", function () {
            submitBtn.disabled = true;
            //btnText.textContent = "Menyimpan...";
            btnSpinner.classList.remove("hidden");
        });
    });
</script>

<!-- toast -->
<script>
    document.getElementById("productForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        const response = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        const data = await response.json();
        if (data.status === "success") {
            showToast("success", data.message);

            setTimeout(() => {
                window.location.href = "{% url 'product_list' %}";
            }, 1500);
        } else {
            showToast("error", data.message || "Terjadi kesalahan, periksa input!");
        }
    });

    // Helper function buat bikin toast
    function showToast(type, message) {
        const container = document.getElementById("toast-container");

        // buat element toast
        const toast = document.createElement("div");
        toast.className = `flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-sm transition-all duration-500 ease-in-out transform translate-x-full opacity-0`;
        toast.role = "alert";

        const icon = type === "success"
            ? `<div class="inline-flex items-center justify-center shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
           </div>`
            : `<div class="inline-flex items-center justify-center shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/></svg>
           </div>`;

        toast.innerHTML = `
        ${icon}
        <div class="ms-3 text-sm font-normal">${message}</div>
        <button type="button" class="ms-auto -mx-1.5 -my-1.5 text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100">
            <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
        </button>
    `;

        // tombol close
        toast.querySelector("button").addEventListener("click", () => {
            hideToast(toast);
        });

        container.appendChild(toast);

        // animasi masuk
        setTimeout(() => {
            toast.classList.remove("translate-x-full", "opacity-0");
            toast.classList.add("translate-x-0", "opacity-100");
        }, 50);

        // auto hide
        setTimeout(() => {
            hideToast(toast);
        }, 2500);
    }

    function hideToast(toast) {
        toast.classList.remove("translate-x-0", "opacity-100");
        toast.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => toast.remove(), 600);
    }
</script>
{% endblock %}